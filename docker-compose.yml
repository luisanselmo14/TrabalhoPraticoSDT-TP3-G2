services:
  ipfs:
    image: ipfs/go-ipfs:v0.12.0
    container_name: ipfs
    # CRÍTICO: Habilitar PubSub Experiment
    command: ["daemon", "--enable-pubsub-experiment", "--migrate=true"]
    ports:
      - "5001:5001"
      - "4001:4001"
      - "8080:8080"
    volumes:
      - ipfs_data:/data/ipfs
    # Healthcheck para garantir que IPFS está pronto antes do Leader iniciar
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - sdt-network

  leader:
    build: .
    image: leader-api:local
    container_name: leader-api
    depends_on:
      ipfs:
        condition: service_healthy  # Espera IPFS estar saudável
    environment:
      - IPFS_MULTIADDR=/dns4/ipfs/tcp/5001
      - IPFS_API_BASE=http://ipfs:5001  # Nova variável
    ports:
      - "8081:8081"
    tty: true
    stdin_open: true
    networks:
      - sdt-network

volumes:
  ipfs_data:

networks:
  sdt-network:
    driver: bridge